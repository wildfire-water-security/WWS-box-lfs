---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
) 

```

# Box Large File Storage (`blfs`)

<!-- badges: start -->

<!-- badges: end -->

`blfs` is an R package that makes it easier to work with **very large files** in GitHub projects.

By default:

-   **GitHub** doesn’t let you upload files larger than **100 MB**.

-   **Git LFS** (Large File Storage) raises the limit to **2 GB**, but it still has problems:

    -   Free accounts have a storage cap.

    -   Even if you delete a file, it stays hidden in the project’s history and still takes up space.

    -   Completely removing these files often means recreating the whole repository and losing commit history.

For the **Wildfire and Water Security (WWS)** project, we have unlimited storage on [Box](https://www.box.com/home).

`blfs` lets us keep the big files in Box while still using GitHub for everything else — so we get the best of both worlds.

## How it works

-   Instead of storing the big file directly in GitHub, `blfs` creates a **small pointer file** that says *where the real file lives in Box*.

-   These pointer files have the extension `.boxtracker` and are stored in GitHub.

-   The actual large files live in Box, inside a special `box-lfs` folder.

## Installation

Install the package from [GitHub](https://github.com/):

```{r install, message=FALSE, warning=FALSE, results=FALSE}
# install.packages("remotes")
remotes::install_github("wildfire-water-security/WWS-box-lfs", subdir="blfs")
library(blfs)
```

------------------------------------------------------------------------

## Creating a new Git repository with Box LFS

```{r include=FALSE}
#setting up clean stucture for running examples 
    #create temp dir so files don't get cluttered
      #make a fake new dir with large files 
      new_dir <- withr::local_tempdir(pattern = "example-repo-")
      data_path <- file.path(fs::path_package("extdata", package = "blfs"), "example-files")
      file.copy(data_path, new_dir, recursive = TRUE)
      
      #make a fake cloned dir with tracked files 
      clone_dir <- withr::local_tempdir(pattern = "example-repo-") 
      data_path <- file.path(fs::path_package("extdata", package = "blfs"), "box-lfs")
      file.copy(data_path, clone_dir, recursive = TRUE)
      file.copy(file.path(fs::path_package("extdata", package = "blfs"), "test.gitignore"), file.path(clone_dir, ".gitignore"))
      unlink(file.path(clone_dir, "box-lfs/upload"), recursive=TRUE)

      
      #make a fake download dir 
      dwd <- withr::local_tempdir(pattern = "example-repo-")     
      data_path <- file.path(fs::path_package("extdata", package = "blfs"), "box-lfs-zip.zip")
      file.copy(data_path, dwd)

```

If you already have a folder you want to turn into a GitHub repository (repo) that uses Box for large files, start with:

```{r echo=FALSE}
#get output before running
tree_output <- capture.output(fs::dir_tree(new_dir))
tree_output[1] <- "~/new_dir"

```

```{r message=FALSE, warning=FALSE}
  new_repo_blfs(dir = new_dir, size = 0.0001) 
```

-   `dir` is the folder you want to set up.

-   `size` is the minimum size (in MB) that counts as a “large” file. Default is **10 MB**, but here we use a small number so our example files are included.

------------------------------------------------------------------------

### File structure before running `new_repo_blfs()`

```{r echo=FALSE}
cat(tree_output, sep = "\n")
```

------------------------------------------------------------------------

### File structure after running `new_repo_blfs()`

```{r echo=FALSE}
tree_output <- capture.output(fs::dir_tree(new_dir))
tree_output[1] <- "~/new_dir"

cat(tree_output, sep = "\n")
```

**What’s new?**

-   There's a new folder, `box-lfs` which contains:

    -   `.boxtracker` pointer files (these replace the large files in GitHub).

    -   An `upload` folder with the real large files, renamed to **hashes** (unique ID codes) so files with the same name don’t overwrite each other.

    -   A `path-hash.csv` file that links the hash back to the original file name and location.

-   There's a new file, `README.md`, the landing page for the repository which alerts users that Box LFS is being used.

------------------------------------------------------------------------

### What you’ll see when you run `new_repo_blfs()`

1.  **Warning about large files**

    ```{r echo=FALSE}
     #making nicer formatted messages and warnings: 
    cat("Warning in new_repo_blfs(dir = new_dir, size = 2e-04): the following files will no longer be tracked by git:\n")
    cat("    example-files/large-file1.txt\n")
    cat("    example-files/large-file2.txt\n")

    ```

    This is **expected** — these files are now tracked by Box, not GitHub.

2.  **Message telling you to upload files to Box**

    ```{r echo=FALSE}
     #making nicer formatted messages and warnings: 
    cat("Please upload files from 'example-repo-abc123/box-lfs/upload' to Box here:\n")
    cat("'Wildfire_Water_Security/02_Nodes/your node/Projects/example-repo-abc123/box-lfs'\n")

    ```

    **Do this next:**

    -   Go to the correct folder in Box for your project.

    -   Inside that project’s folder, create a `box-lfs` folder if it doesn’t exist.

    -   Upload everything from your local `upload` folder into Box.

3.  **Prompt asking for the Box link**

    ```{r echo=FALSE}
     #making nicer formatted messages and warnings: 
    cat("what is the box link to the folder where the data is now backed up? ")
    ```

    Paste the Box share link here — the package stores it so it knows where to get the files later.

------------------------------------------------------------------------

## Cloning a GitHub repository using Box LFS

When you clone a GitHub repo that uses Box LFS, you get the code and .boxtracker pointer files — but not the big files themselves. To download those files and put them in the right place, run:

```{r echo=FALSE}
#get intitial file tree 
tree_output <- capture.output(fs::dir_tree(clone_dir))
tree_output[1] <- "~/clone_dir"

```

```{r message=FALSE, warning=FALSE}
clone_repo_blfs(dir=clone_dir, download=dwd)
```

-   `dir` is the folder with the cloned repository.
-   `download` is the folder with the downloaded `.zip` file.

------------------------------------------------------------------------

### Check if a repo uses Box LFS

You can check by running:

```{r}
check_blfs(clone_dir)
```

If it says `TRUE`, the repo uses Box LFS.

------------------------------------------------------------------------

### File structure before running `clone_repo_blfs()`

```{r echo=FALSE}
cat(tree_output, sep = "\n")
```

------------------------------------------------------------------------

### File structure after running `clone_repo_blfs()`

```{r echo=FALSE}
tree_output <- capture.output(fs::dir_tree(clone_dir))
tree_output[1] <- "~/clone_dir"

cat(tree_output, sep = "\n")
```

------------------------------------------------------------------------

### What you’ll see when you run `clone_repo_blfs()`

1.  **Message telling you where to get the files from Box**

    ```{r echo=FALSE}
     #making nicer formatted messages and warnings: 
    cat("Please download files from Box here:\n")
    cat("'Wildfire_Water_Security/02_Nodes/your node/Projects/example-repo-abc123/box-lfs'\n")
    cat("they will be automatically moved to the correct locations from your downloads folder")

    ```

    **Do this next:**

    -   Go to the provided Box link or Box path.

    -   Download the folder (Box will give it to you as a .zip file).

2.  **Prompt to continue**

    ```{r echo=FALSE}
     #making nicer formatted messages and warnings: 
    cat("hit any key once files have been downloaded to continue setting up the repo")

    ```

    Press Enter when your download is ready.

3.  **Prompt to confirm the zip file location**

    ```{r echo=FALSE}
     #making nicer formatted messages and warnings: 
    cat(paste0("Zip file for downloaded data appears to be: ", file.path("~/Downloads/box-lfs-zip.zip"), "\n"))
    cat("Press enter to use this file or provide a different file path.")

    ```

    If this is correct, press Enter. If not, type the correct file path and press Enter.

**With this, your cloned repo will have the correct large files in the right locations.**

------------------------------------------------------------------------

## Pushing a GitHub repository using Box LFS

**Before** you push changes to a repository that uses Box LFS, you need to:

1.   Check if any **tracked files** have been updated.

2.   See if there are **new large files** that should be tracked.

You can do both with:

```{r message=FALSE, warning=FALSE}
push_repo_blfs(dir=clone_dir, size=0.0001)
```

-   `dir` is your local repository folder.
-   `size` is the minimum file size (in MB) that counts as a “large” file. Default is **10 MB**.
-    Here we use a smaller number so our example files are included.

### What you'll see when you run `push_repo_blfs()`:

1.  **Message telling you to upload files to Box**

    You'll only see this message if there are **new or updated files** that need to be uploaded to Box. If there are no changes, the function will finish without printing anything.

    ```{r echo=FALSE}
     #making nicer formatted messages and warnings: 
    cat("Please upload files from 'example-repo-abc123/box-lfs/upload' to Box here:\n")
    cat("'Wildfire_Water_Security/02_Nodes/your node/Projects/example-repo-abc123/box-lfs'\n")
    ```

    **Do this next:**

    -   Go to the correct folder in Box for your project.
    -   Inside that project’s folder, go to the `box-lfs` folder.
    -   Upload everything from your **local** `upload` folder into Box. 
    
------------------------------------------------------------------------

## Pulling a GitHub repository using Box LFS

**After** you pull changes from a GitHub repository that uses Box LFS, you need to:

1.   Check if any **tracked files** have been updated on Box.

2.   Check if any local tracked files should be pushed before downloading the updated files.

You can do both with:

```{r message=FALSE, warning=FALSE}
pull_repo_blfs(dir=clone_dir, download=dwd)
```

-   `dir` is your local repository folder.
-   `download` is the folder with the downloaded `.zip` file.

### What you'll see when you run `pull_repo_blfs()`:

1.  **Message telling you to upload files to Box**

    You'll only see this message if there are **new or updated files** that need to be **uploaded** to Box. We run this check to make sure that any local changes to the tracked files are 

    ```{r echo=FALSE}
     #making nicer formatted messages and warnings: 
    cat("Please upload files from 'example-repo-abc123/box-lfs/upload' to Box here:\n")
    cat("'Wildfire_Water_Security/02_Nodes/your node/Projects/example-repo-abc123/box-lfs'\n")
    ```

    **Do this next:**

    -   Go to the correct folder in Box for your project.

    -   Inside that project’s folder, go to the `box-lfs` folder.

    -   Upload everything from your **local** `upload` folder into Box.

2.  **Message telling you where to get the files from Box** 
    
    You'll only see this message if there are **new or updated files** that need to be **downloaded** from Box.

    ```{r echo=FALSE}
     #making nicer formatted messages and warnings: 
    cat("Please download files from Box here:\n")
    cat("'Wildfire_Water_Security/02_Nodes/your node/Projects/example-repo-abc123/box-lfs'\n")
    cat("they will be automatically moved to the correct locations from your downloads folder")

    ```

    **Do this next:**

    -   Go to the provided Box link or Box path.

    -   Download the folder (Box will give it to you as a .zip file).

